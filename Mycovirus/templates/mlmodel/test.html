{% extends "./index.html" %}
{% block upload %}
{% load crispy_forms_tags %}
{% load static %}
<link rel='stylesheet' href="{% static 'css/predict.css' %}">

<br><br>
<h4>Upload File</h4>
<p>Please upload file(s) containing sequence(s) of virus genome.</p>
<div class="row fileupload_container mb-5 mt-4">
    <div class="col-md-5 mb-5">    
        <form id="fileinfoform" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ upload_form.filepath}}
            <button type="submit" value="upload_form" class="btn btn-secondary mt-3" style="width: 100%; height: 13%;">Upload</button>		
        </form>
    </div>  
    <div class="col-md-6 ml-md-5">
        <form id="filelistform" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                {{ filelist_form.filelist }}
            </div>
            <div class="row float-right mt-2">
                <div class="col-md-6 alignment_box">
                    <!-- {{ filelist_form.alignment | as_crispy_field }} -->
                </div>
                <div class="col-md-6">
                    <div class="btn-group" style="width: 105%;">
                        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="width: 105%;">Actions </button>
                        <div class="dropdown-menu">
                            <button type="submit" value="filelist_form" name="add_filelist" class="dropdown-item">Add to prediction</button>		
                            <button value="filelist_form" name="delete_filelist" class="dropdown-item">Delete files</button>		
                            <div class="dropdown-divider"></div>
                            <button button value="filelist_form" name="action" class="dropdown-item disabled">Save to database</button>		
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


<h4>Predict</h4>
<p>Please fill in the form below before making a prediction.<br/><small style="color:#6c757d"></small></p>
    <form action="{% url 'updateParams' %}" method="POST">
        {% csrf_token %}
        <div class="row ">
            <div class="col-md-4">
                {{ predict_form.mlmodels | as_crispy_field }}
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <button type="submit" id="choose_model_btn" value="choose_model" name="choose_model" class="btn btn-secondary" style="width: 100%">Choose Model</button>
            </div>
        </div>
    </form>
    <form action="{% url 'updateParams' %}" method="POST">
        {% csrf_token %}
        <!-- {{ parameters_form.non_field_errors }} -->
        <div class="d-flex flex-row">
            {% for field in parameters_form%}
            <div class="p-2">{{ field|as_crispy_field }}</div>
            {% endfor %}
        </div>
        <div class="row">
            <div class="col-md-2">
                <button type="submit" id="submit_params_btn" value="submit_params" name="submit_params" class="btn btn-secondary" style="width: 100%">Submit Parameters</button>
            </div>
        </div>
    </form>
<br><br><br>
content: {{content}}
<br><br><br>
last_predict_info: {{last_predict_info}}
<br><br><br>
last_predict_info_id: {{last_predict_info_id}}
<br><br><br>
last_predict_info_parameters: {{last_predict_info_parameters}}
<br><br><br>
action: {{action}}
<br><br><br>

{% if files.count == 0 %}
<script>
    $("#predictbtn").on("click", function() {
        alert("Please upload at least one file before making a prediction.");
        return false;
    })
</script>
{% endif %}

<script>
    function resize() {
        let height = $('.upload_container').height();
        let width = $('.upload_container').width();
        $('.filelist_container').height(height);
        $('.filelist_container').width(1.5*width);
    }
    $(window).load(function() {
        resize();
    })
    $(window).resize(function() {
        resize();
    })
    $("#select_all").click(function() {
        $(".filelist_container input:checkbox").prop("checked", this.checked);
    })
    $("#choose_model_btn").click(function() {
        sessionStorage.setItem('scrollpos', window.scrollY);
    })
    // $("#submit_params_btn").click(function() {
    //     sessionStorage.setItem('scrollpos', window.scrollY);
    // })
    document.addEventListener("DOMContentLoaded", function (event) {
        var scrollpos = sessionStorage.getItem('scrollpos');
        if (scrollpos) {
            window.scrollTo(0, scrollpos);
            sessionStorage.removeItem('scrollpos');
        }
    });
</script>
<script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }}"; </script>
<script>
    function resetData() {
        $.ajax({
            url: '../resetData/',
            type: 'POST',
            dataType: 'json',
            data: {csrfmiddlewaretoken: window.CSRF_TOKEN},
        }); 
    }
    window.addEventListener("unload", function(event) { 
        resetData();
    });



    // document.addEventListener("DOMContentLoaded", function (event) {
    //     var scrollpos = sessionStorage.getItem('scrollpos');
    //     if (scrollpos) {
    //         window.scrollTo(0, scrollpos);
    //         // sessionStorage.removeItem('scrollpos');
    //         sessionStorage.clear();
    //         resetData();
    //     }
    // });

    // window.addEventListener("beforeunload", function (e) {
    //     sessionStorage.setItem('scrollpos', window.scrollY);
    // });
</script>
{% endblock %}
